name: Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Start PostgreSQL
        run: |
          docker-compose up -d
          sleep 5

      - name: Run migrations
        run: |
          docker-compose exec -T postgres psql -U fintrack -d fintrack -f - < sql/migrations/001_init.sql
          docker-compose exec -T postgres psql -U fintrack -d fintrack -f - < sql/migrations/002_indexes.sql

      - name: Run unit tests
        run: make test-unit
        env:
          TEST_DATABASE_URL: postgres://fintrack:fintrack@localhost:5432/fintrack

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          flags: unit
          name: codecov-umbrella

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Start PostgreSQL
        run: |
          docker-compose up -d
          sleep 5

      - name: Run migrations
        run: make migrate

      - name: Run integration tests
        run: make test-integration
        env:
          DATABASE_URL: postgres://fintrack:fintrack@localhost:5432/fintrack_test
          TEST_DATABASE_URL: postgres://fintrack:fintrack@localhost:5432/fintrack_test

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          flags: integration
          name: codecov-umbrella

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Start PostgreSQL
        run: |
          docker-compose up -d
          sleep 5

      - name: Run migrations
        run: make migrate

      - name: Run security tests
        run: make test-security
        env:
          DATABASE_URL: postgres://fintrack:fintrack@localhost:5432/fintrack
          TEST_DATABASE_URL: postgres://fintrack:fintrack@localhost:5432/fintrack

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Start PostgreSQL
        run: |
          docker-compose up -d
          sleep 5

      - name: Run migrations
        run: make migrate

      - name: Run E2E tests
        run: make test-e2e
        env:
          DATABASE_URL: postgres://fintrack:fintrack@localhost:5432/fintrack
          TEST_DATABASE_URL: postgres://fintrack:fintrack@localhost:5432/fintrack

  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, security-tests, e2e-tests]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Stop PostgreSQL
        run: make docker-down
